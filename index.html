<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rekha AI - Lakhu Teleservices</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons (Global) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom Animations for the Orb */
        @keyframes pulse-ring {
            0% { transform: scale(0.8); opacity: 0.5; }
            100% { transform: scale(2); opacity: 0; }
        }
        
        .orb-idle {
            background: radial-gradient(circle at 30% 30%, #475569, #1e293b);
            box-shadow: 0 0 20px #334155;
        }
        
        .orb-listening {
            background: radial-gradient(circle at 30% 30%, #3b82f6, #1d4ed8);
            box-shadow: 0 0 40px #2563eb;
            animation: breathe 2s infinite ease-in-out;
        }
        
        .orb-processing {
            background: radial-gradient(circle at 30% 30%, #f97316, #c2410c);
            box-shadow: 0 0 40px #ea580c;
            animation: spin 3s linear infinite;
        }
        
        .orb-speaking {
            background: radial-gradient(circle at 30% 30%, #22c55e, #15803d);
            box-shadow: 0 0 50px #16a34a;
            animation: talk 0.5s infinite alternate;
        }

        @keyframes breathe {
            0% { transform: scale(0.95); box-shadow: 0 0 20px #2563eb; }
            50% { transform: scale(1.05); box-shadow: 0 0 60px #2563eb; }
            100% { transform: scale(0.95); box-shadow: 0 0 20px #2563eb; }
        }

        @keyframes talk {
            0% { transform: scale(1); box-shadow: 0 0 30px #16a34a; }
            100% { transform: scale(1.1); box-shadow: 0 0 60px #16a34a; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body class="bg-slate-950 text-white h-screen overflow-hidden flex flex-col items-center justify-center font-sans">
    <div id="root" class="w-full h-full flex flex-col"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- Configuration & Constants ---

        const DEFAULT_GEMINI_KEY = "AIzaSyCqQKhHmTy1Vv8cfMTMCCH4vB2fUPJlRLQ";
        const DEFAULT_ELEVENLABS_KEY = "80050d36791355b078eeb444e5a25ec81e9bb0af33d0b66a7d6fcad8dc9fa925";
        const DEFAULT_VOICE_ID = "xoV6iGVuOGYHLWjXhVC7"; // Muskan

        const SCRIPTS = {
            1: {
                title: "1. Mahatvapurn Jankari",
                opener: "Namaskar, mahatvapurn jankari ka call hai. Aapka DishTV recharge khatam hone wala hai. 200 rupaye ka recharge zaruri hai. Connection chalu rakhun?",
                systemPrompt: `You are Rekha from Lakhu Teleservices (DishTV). 
                Language: Hindi (speak clearly). If user speaks Gujarati, switch to Gujarati. NEVER speak English unless explicitly asked to translate.
                Core Rule: Minimum recharge is 200 Rupees. No offers allowed.
                Context: Alerting user about critical recharge status.
                Goal: Convince them to recharge 200 Rs immediately to keep connection active.
                Rebuttals:
                - If "Yes/Time": Thank them, ask when they will do it.
                - If "No/Close": Warn about connection cut.
                - If "Out of Station/TV Broken/Exams": Say minimum balance maintenance is mandatory regardless of usage.
                - If "New Connection": politely say this department is only for renewals.
                Keep responses short (under 2 sentences) and professional.`
            },
            2: {
                title: "2. Last Date (Urgency)",
                opener: "Namaskar, Rekha bol rahi hoon. Aaj aakhri din hai. Shaam 6 baje tak 200 rupaye ka recharge nahi kiya toh connection hamesha ke liye band ho jayega. Connection chalu rakhun?",
                systemPrompt: `You are Rekha from Lakhu Teleservices (DishTV). 
                Language: Hindi.
                Core Rule: DEADLINE IS 6 PM TODAY. Minimum 200 Rs.
                Tone: Very Urgent, Warning.
                Goal: Scare them slightly about the deadline. If they miss 6 PM, they have to pay extra reactivation charges.
                Rebuttals: Emphasize the 6 PM deadline for every excuse. "Sir/Ma'am, 6 baje ke baad charge badh jayega."`
            },
            3: {
                title: "3. Chalu Ya Bandh",
                opener: "Namaskar, Lakhu Teleservices se service call hai. Aapka connection chalu rakhna chahte ho ya hamesha ke liye band?",
                systemPrompt: `You are Rekha from Lakhu Teleservices.
                Language: Hindi.
                Context: A binary choice service call.
                Goal: Get a clear "Chalu" (Keep) or "Band" (Close) answer.
                Logic: 
                - If "Chalu": Ask to recharge 200 Rs now.
                - If "Band": Ask "Kya hamesha ke liye band kar de?" to confirm.
                - Minimum recharge 200 Rs. No offers.`
            },
            4: {
                title: "4. Bandh Ho Chuka Hai",
                opener: "Namaskar. Ye aakhri call hai. Aapka connection company se band ho chuka hai. Kya dobara chalu karna hai?",
                systemPrompt: `You are Rekha from Lakhu Teleservices.
                Language: Hindi.
                Context: Connection is ALREADY closed/suspended.
                Goal: Reactivation.
                Logic: Tell them this is the final chance before data deletion. 
                - To reactivate: Recharge 200 Rs immediately.
                - If they refuse: Say "Dhanyavaad, hum file close kar rahe hain."`
            },
            5: {
                title: "5. Offer (Special)",
                opener: "Namaskar, aapka connection band hai. Kya koi asuwidha ho rahi hai?",
                systemPrompt: `You are Rekha from Lakhu Teleservices.
                Language: Hindi.
                Context: Retention call.
                Special Rule: THIS IS THE ONLY SCRIPT WITH OFFERS.
                Offers: 
                - Recharge 6 months, get 3 months free.
                - Recharge 1 year, get 6 months free.
                Goal: Find out why they stopped watching and offer the deal to bring them back.`
            }
        };

        // --- Helper Components ---

        const Icon = ({ name, size = 24, className = "" }) => {
            useEffect(() => {
                if (window.lucide) {
                    window.lucide.createIcons();
                }
            }, [name]);
            return <i data-lucide={name} width={size} height={size} className={className}></i>;
        };

        const SettingsModal = ({ isOpen, onClose, settings, onSave }) => {
            const [localSettings, setLocalSettings] = useState(settings);

            useEffect(() => { setLocalSettings(settings); }, [settings]);

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4">
                    <div className="bg-slate-900 border border-slate-700 rounded-xl p-6 w-full max-w-md shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h2 className="text-xl font-bold text-white">Settings</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-white">
                                <Icon name="x" />
                            </button>
                        </div>
                        
                        <div className="space-y-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">Gemini API Key</label>
                                <input 
                                    type="password" 
                                    value={localSettings.geminiKey}
                                    onChange={(e) => setLocalSettings({...localSettings, geminiKey: e.target.value})}
                                    className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 outline-none"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">ElevenLabs API Key</label>
                                <input 
                                    type="password" 
                                    value={localSettings.elevenLabsKey}
                                    onChange={(e) => setLocalSettings({...localSettings, elevenLabsKey: e.target.value})}
                                    className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 outline-none"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-slate-400 mb-1">Voice ID</label>
                                <input 
                                    type="text" 
                                    value={localSettings.voiceId}
                                    onChange={(e) => setLocalSettings({...localSettings, voiceId: e.target.value})}
                                    className="w-full bg-slate-800 border border-slate-700 rounded-lg px-3 py-2 text-white focus:ring-2 focus:ring-blue-500 outline-none"
                                />
                            </div>
                        </div>

                        <div className="mt-6 flex justify-end gap-3">
                            <button onClick={onClose} className="px-4 py-2 text-slate-300 hover:text-white">Cancel</button>
                            <button 
                                onClick={() => { onSave(localSettings); onClose(); }}
                                className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg font-medium"
                            >
                                Save Configuration
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main App Component ---

        const App = () => {
            // State
            const [status, setStatus] = useState("idle"); // idle, speaking, listening, processing
            const statusRef = useRef("idle"); // Ref to keep track of status in event listeners
            
            const [scriptId, setScriptId] = useState(1);
            const [transcript, setTranscript] = useState([]);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [errorMsg, setErrorMsg] = useState(null);
            
            // Settings State with Persistence
            const [settings, setSettings] = useState(() => {
                const saved = localStorage.getItem("rekha_settings");
                return saved ? JSON.parse(saved) : {
                    geminiKey: DEFAULT_GEMINI_KEY,
                    elevenLabsKey: DEFAULT_ELEVENLABS_KEY,
                    voiceId: DEFAULT_VOICE_ID
                };
            });

            // Refs
            const recognitionRef = useRef(null);
            const audioRef = useRef(new Audio());
            const chatHistoryRef = useRef([]); 

            // Update status ref whenever status state changes
            useEffect(() => {
                statusRef.current = status;
            }, [status]);

            // Initialize Speech Recognition
            useEffect(() => {
                if ('webkitSpeechRecognition' in window) {
                    const recognition = new webkitSpeechRecognition();
                    recognition.continuous = false; // We handle restart manually for better control
                    recognition.interimResults = false;
                    recognition.lang = 'hi-IN'; // Default Hindi
                    
                    recognition.onstart = () => {
                        console.log("Recognition started");
                        if (statusRef.current !== 'listening') {
                             // Only update if not already set (prevents flicker)
                             // This is mostly for visual sync if manually triggered
                        }
                    };

                    recognition.onresult = (event) => {
                        const text = event.results[0][0].transcript;
                        console.log("Recognition result:", text);
                        if (text && text.trim().length > 0) {
                            handleUserSpeech(text);
                        }
                    };

                    recognition.onerror = (event) => {
                        console.error("Speech Recognition Error", event.error);
                        if(event.error === 'not-allowed') {
                            setErrorMsg("Microphone access denied. Please allow microphone permissions.");
                            setStatus("idle");
                        }
                        // 'no-speech' is handled by onend
                    };

                    recognition.onend = () => {
                        console.log("Recognition ended. Current status:", statusRef.current);
                        // CRITICAL FIX: If we are still in 'listening' mode (meaning we didn't get a result yet),
                        // restart the recognition immediately. Browsers stop it on silence.
                        if (statusRef.current === 'listening') {
                            try {
                                recognition.start();
                            } catch (e) {
                                console.log("Restart failed", e);
                            }
                        }
                    };

                    recognitionRef.current = recognition;
                } else {
                    setErrorMsg("Your browser does not support Web Speech API (Use Chrome).");
                }
            }, [settings]); // Re-init if settings change

            // --- Logic Functions ---

            const saveSettings = (newSettings) => {
                setSettings(newSettings);
                localStorage.setItem("rekha_settings", JSON.stringify(newSettings));
            };

            const addToTranscript = (role, text) => {
                setTranscript(prev => [...prev, { role, text }]);
                chatHistoryRef.current.push({ 
                    role: role === "User" ? "user" : "model", 
                    parts: [{ text: text }] 
                });
            };

            const playAudio = async (text) => {
                try {
                    setStatus("processing"); // Momentary processing state while fetching audio
                    
                    const response = await fetch(`https://api.elevenlabs.io/v1/text-to-speech/${settings.voiceId}`, {
                        method: 'POST',
                        headers: {
                            'xi-api-key': settings.elevenLabsKey,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            text: text,
                            model_id: "eleven_multilingual_v2",
                            voice_settings: { stability: 0.5, similarity_boost: 0.8 }
                        })
                    });

                    if (!response.ok) throw new Error("ElevenLabs API Error");

                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    
                    audioRef.current.src = url;
                    audioRef.current.playbackRate = 1.15; // Speed increased by 15%
                    
                    setStatus("speaking");
                    addToTranscript("Rekha", text);

                    audioRef.current.onended = () => {
                        // After AI speaks, start listening for user
                        startListening();
                    };
                    
                    await audioRef.current.play();

                } catch (err) {
                    setErrorMsg("Audio Generation Failed: " + err.message);
                    setStatus("idle");
                }
            };

            const startListening = () => {
                setStatus("listening");
                if (recognitionRef.current) {
                    try {
                        recognitionRef.current.start();
                    } catch (e) {
                        // Already started or busy, which is fine
                        console.log("Recognition start called but already active/busy");
                    }
                }
            };

            const handleUserSpeech = async (userText) => {
                // Immediately switch state to processing to prevent 'onend' from restarting listener
                setStatus("processing");
                statusRef.current = "processing"; // Force ref update for immediate safety in event loop

                addToTranscript("User", userText);

                try {
                    // Call Gemini
                    const script = SCRIPTS[scriptId];
                    const systemPrompt = script.systemPrompt;
                    
                    let historyPayload = [];
                    // Add previous turns
                    const recentHistory = chatHistoryRef.current.slice(-6, -1); 
                    
                    historyPayload = [
                        { role: "user", parts: [{ text: systemPrompt }] },
                        { role: "model", parts: [{ text: "Samajh gayi. Main Rekha hoon. Boliye." }] },
                        ...recentHistory,
                        { role: "user", parts: [{ text: userText }] }
                    ];

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${settings.geminiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: historyPayload })
                    });

                    if (!response.ok) throw new Error("Gemini API Error");

                    const data = await response.json();
                    const aiText = data.candidates[0].content.parts[0].text;

                    // Speak the response
                    playAudio(aiText);

                } catch (err) {
                    setErrorMsg("AI Processing Failed: " + err.message);
                    setStatus("idle");
                }
            };

            const startCall = () => {
                setErrorMsg(null);
                setTranscript([]);
                chatHistoryRef.current = [];
                
                // Speak Opener
                const opener = SCRIPTS[scriptId].opener;
                
                chatHistoryRef.current.push({ role: "model", parts: [{ text: opener }] });
                playAudio(opener); 
            };

            const hangupCall = () => {
                setStatus("idle"); // This will stop the auto-restart in onend
                statusRef.current = "idle";
                if (recognitionRef.current) recognitionRef.current.stop();
                audioRef.current.pause();
                audioRef.current.currentTime = 0;
            };

            // --- Render ---

            return (
                <div className="flex flex-col h-full w-full max-w-lg mx-auto bg-slate-900 border-x border-slate-800 relative shadow-2xl">
                    
                    {/* Header */}
                    <header className="p-4 border-b border-slate-800 flex justify-between items-center bg-slate-900/90 backdrop-blur z-10">
                        <div className="flex flex-col">
                            <h1 className="text-lg font-bold text-white tracking-wide">LAKHU TELESERVICES</h1>
                            <span className="text-xs text-blue-400 font-medium">AI VOICE ASSISTANT: REKHA</span>
                        </div>
                        <button onClick={() => setIsSettingsOpen(true)} className="p-2 text-slate-400 hover:text-white transition-colors">
                            <Icon name="settings" />
                        </button>
                    </header>

                    {/* Script Selector */}
                    <div className="px-4 py-3 bg-slate-800/50">
                        <label className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-1 block">Active Script</label>
                        <div className="relative">
                            <select 
                                value={scriptId} 
                                onChange={(e) => setScriptId(Number(e.target.value))}
                                disabled={status !== "idle"}
                                className="w-full bg-slate-900 text-white border border-slate-700 rounded-lg p-3 appearance-none focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer disabled:opacity-50"
                            >
                                {Object.keys(SCRIPTS).map(id => (
                                    <option key={id} value={id}>{SCRIPTS[id].title}</option>
                                ))}
                            </select>
                            <div className="absolute right-3 top-3.5 text-slate-400 pointer-events-none">
                                <Icon name="chevron-down" size={16} />
                            </div>
                        </div>
                    </div>

                    {/* Main Visualizer Area */}
                    <div className="flex-1 flex flex-col items-center justify-center relative min-h-[300px]">
                        
                        {/* Status Label */}
                        <div className="absolute top-4 text-sm font-medium tracking-widest uppercase">
                            {status === 'idle' && <span className="text-slate-500">Ready to Call</span>}
                            {status === 'listening' && <span className="text-blue-400 animate-pulse">Listening...</span>}
                            {status === 'processing' && <span className="text-orange-400">Processing...</span>}
                            {status === 'speaking' && <span className="text-green-400">Rekha Speaking...</span>}
                        </div>

                        {/* The Orb */}
                        <div className={`w-40 h-40 rounded-full transition-all duration-500 ${
                            status === 'idle' ? 'orb-idle' :
                            status === 'listening' ? 'orb-listening' :
                            status === 'processing' ? 'orb-processing' :
                            status === 'speaking' ? 'orb-speaking' : ''
                        }`}></div>

                        {/* Error Message Toast */}
                        {errorMsg && (
                            <div className="absolute bottom-4 bg-red-500/90 text-white px-4 py-2 rounded-lg text-xs max-w-[80%] text-center">
                                {errorMsg}
                            </div>
                        )}
                    </div>

                    {/* Transcript Box */}
                    <div className="h-48 bg-slate-950 border-t border-slate-800 overflow-y-auto p-4 space-y-3 scrollbar-hide">
                        {transcript.length === 0 ? (
                            <div className="text-center text-slate-600 text-sm mt-10">
                                Conversation transcript will appear here...
                            </div>
                        ) : (
                            transcript.map((line, idx) => (
                                <div key={idx} className={`flex ${line.role === 'User' ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-[80%] rounded-lg px-3 py-2 text-sm ${
                                        line.role === 'User' 
                                            ? 'bg-blue-600 text-white rounded-br-none' 
                                            : 'bg-slate-800 text-slate-200 rounded-bl-none'
                                    }`}>
                                        <span className="text-xs font-bold opacity-50 block mb-0.5">{line.role}</span>
                                        {line.text}
                                    </div>
                                </div>
                            ))
                        )}
                    </div>

                    {/* Controls */}
                    <div className="p-6 bg-slate-900 border-t border-slate-800">
                        {status === 'idle' ? (
                            <button 
                                onClick={startCall}
                                className="w-full py-4 bg-green-600 hover:bg-green-500 active:bg-green-700 text-white rounded-xl font-bold text-lg shadow-lg shadow-green-900/20 flex items-center justify-center gap-2 transition-all"
                            >
                                <Icon name="phone" /> Initiate Call
                            </button>
                        ) : (
                            <button 
                                onClick={hangupCall}
                                className="w-full py-4 bg-red-600 hover:bg-red-500 active:bg-red-700 text-white rounded-xl font-bold text-lg shadow-lg shadow-red-900/20 flex items-center justify-center gap-2 transition-all"
                            >
                                <Icon name="phone-off" /> Disconnect
                            </button>
                        )}
                    </div>

                    {/* Settings Modal */}
                    <SettingsModal 
                        isOpen={isSettingsOpen} 
                        onClose={() => setIsSettingsOpen(false)}
                        settings={settings}
                        onSave={saveSettings}
                    />

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
